<!DOCTYPE html>
<html>
<head>
    <title>14-continuations-2.scala</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <style type="text/css">
        /*--------------------- Layout and Typography ----------------------------*/
        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
            font-size: 15px;
            line-height: 22px;
            color: #252519;
            margin: 0; padding: 0;
        }
        a {
            color: #261a3b;
        }
        a:visited {
            color: #261a3b;
        }
        p {
            margin: 0 0 15px 0;
        }
        h4, h5, h6 {
            color: #333;
            padding: 6px 0 6px 0;
            font-size: 13px;
        }
        h2, h3 {
            padding-bottom: 15px;
            color: #000;
            overflow: hidden;
        }
        h1 {
            /*padding-top: 40px;*/
            padding-bottom: 15px;
            color: #000;
        }
        #container {
            position: relative;
        }
        /*#background {
            position: fixed;
            top: 0; left: 525px; right: 0; bottom: 0;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
            z-index: -1;
        }*/
        #jump_to, #jump_page {
            background: white;
            -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
            -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
            font: 10px Arial;
            text-transform: uppercase;
            cursor: pointer;
            text-align: right;
        }
        #jump_to, #jump_wrapper {
            position: fixed;
            right: 0; top: 0;
            padding: 5px 10px;
        }
        #jump_wrapper {
            padding: 0;
            display: none;
        }
        #jump_to:hover #jump_wrapper {
            display: block;
        }
        #jump_page {
            padding: 5px 0 3px;
            margin: 0 0 25px 25px;
        }
        #jump_page .source {
            display: block;
            padding: 5px 10px;
            text-decoration: none;
            border-top: 1px solid #eee;
        }
        #jump_page .source:hover {
            background: #f5f5ff;
        }
        #jump_page .source:first-child {
        }
        table td {
            border: 0;
            outline: 0;
        }
        td.docs, th.docs {
            max-width: 450px;
            min-width: 450px;
            min-height: 5px;
            padding: 10px 25px 1px 50px;
            overflow-x: hidden;
            vertical-align: top;
            text-align: left;
        }
        .docs pre {
            margin: 15px 0 15px;
            padding-left: 15px;
        }
        .docs p tt, .docs p code, .doc code {
            background: #f8f8ff;
            border: 1px solid #dedede;
            font-size: 12px;
            padding: 0 0.2em;
        }
        .pilwrap {
            position: relative;
        }
        .pilcrow {
            font: 12px Arial;
            text-decoration: none;
            color: #454545;
            position: absolute;
            top: 3px; left: -20px;
            padding: 1px 2px;
            opacity: 0;
            -webkit-transition: opacity 0.2s linear;
        }
        td.docs:hover .pilcrow {
            opacity: 1;
        }
        td.code, th.code {
            padding: 10px 10px 10px 50px;
            width: 100%;
            vertical-align: top;
            background: #f5f5ff;
            border-left: 1px solid #e5e5ee;
        }
        pre, tt, code {
            font-size: 12px; line-height: 18px;
            font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
            margin: 0; padding: 0;
        }

        /*---------------------- Prettify Syntax Highlighting -----------------------------*/
        .str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun{color:#660}.pln{color:#000}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec{color:#606}pre.prettyprint{padding:2px;border:1px solid #888}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}@media print{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun{color:#440}.pln{color:#000}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}

        table.doc { margin-bottom: 20px; }
        td.doc { border-bottom: 1px dashed #708090; }
        td.param { font-weight: bold; }
        td.return { font-weight: bold; text-decoration: underline; }
    </style>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js" type="text/javascript"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/trunk/src/lang-scala.js" type="text/javascript"></script>
</head>

<body onload="prettyPrint()">
<div id="container">
    <div id="background"></div>
    <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
            <div id="jump_page">
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/01-intro.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/01-intro.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/02-desugaring.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/03-ae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/03-ae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/04-wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/04-wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/05-f1wae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/06-fae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/06-fae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/07-lcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/08-rcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/09-bcfae.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/10-gc.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/10-gc.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/11-syntacticvsmeta.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/12-churchencoding.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/13-continuations-1.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/14-continuations-2.html
                </a>
                
                <a class="source" href="/Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html">
                    /Users/klaus/git/PL1-2014/lecturenotes/17-firstclasscontinuations.html
                </a>
                
            </div>
        </div>
    </div>

    <table cellpadding="0" cellspacing="0">
        <thead>
        <tr>
            <th class="docs">
                <h1>14-continuations-2.scala</h1>
            </th>
            <th class="code"></th>
        </tr>
        </thead>
        <tbody>
        
        <tr id="section_0">
            <td class="docs">
                <div class="pilwrap">
                    <a class="pilcrow" href="#section_0">&#182;</a>
                </div>
                
            </td></tr><tr>
            <td class="code">
                <pre><code class='prettyprint lang-scala'>object transform {

  // Let's encode the three properties of programs in CPS in the
  // Scala type system. This will help us to get the
  // transformation right.

  // Arbitrary expressions:

  sealed abstract class Exp
  case class Num(n: Int) extends Exp
  case class Id(name: Symbol) extends Exp
  case class Add(lhs: Exp, rhs: Exp) extends Exp
  implicit def num2exp(n: Int) = Num(n)
  implicit def id2exp(s: Symbol) = Id(s)
   
  case class Fun(param: Symbol, body: Exp) extends Exp
  case class App (funExpr: Exp, argExpr: Exp) extends Exp

  // Expressions in CPS:

  sealed abstract class ContExp
  sealed abstract class TrivialContExp extends ContExp
  sealed abstract class NontrivialContExp extends ContExp

  case class ContNum(n: Int) extends TrivialContExp

  case class ContId(name: Symbol) extends TrivialContExp
  // ContId would be NontrivialContExp if call-by-name

  case class ContAdd(lhs: TrivialContExp, rhs: TrivialContExp)
      extends TrivialContExp
  // can also decide to ContAdd(...) extends NontrivialContExp
  // TODO explain how to deal with nontrivial adds and 2nd req.

  // lhs and rhs *have to be* TrivialContExp because they are
  // not in tail position!

  implicit def num2contexp(n: Int) = ContNum(n)
  implicit def id2contexp(s: Symbol) = ContId(s)
   
  case class ContApp(funExpr: TrivialContExp,
                     argExpr: TrivialContExp,
                     cont: Continuation)
      extends NontrivialContExp

  // funExpr and argExpr *have to be* trivial because they
  // are not in tail position

  case class ContFun(param: Symbol,
                     contParam: Symbol,
                     body: NontrivialContExp)
      extends TrivialContExp

  // sometimes subexpressions can be nontrivial, for example:
  //
  // case class If(condExpr: trivial,
  //               thenBranch: nontrivial,
  //               elseBranch: nontrivial)
  //   extends Nontrivial

  // We also need continuations!

  sealed abstract class Continuation extends ContExp

  case class FunContinuation(
    param: Symbol,
    body: NontrivialContExp)
      extends Continuation

  case class IdContinuation(
    name: Symbol)
      extends Continuation

  implicit def id2cont(name: Symbol) = IdContinuation(name)

  case class AppContinuation(
    cont: Continuation,
    arg: TrivialContExp)
      extends NontrivialContExp

  // We need to generate fresh names
  var counter: Int = 0
  def freshName(name: String) = {
    counter += 1
    Symbol(name + &quot;_&quot; + counter)
  }

  // Ok, now we can write a transformation of arbitrary
  // expressions into non-trivial expressions in CPS.

  def cps(e: Exp, k: Continuation): NontrivialContExp =
    e match {
      case Num(n) =&gt; AppContinuation(k, ContNum(n))
      case Id(name) =&gt; AppContinuation(k, ContId(name))
      case Add(lhs, rhs) =&gt; {
        val x = freshName(&quot;x&quot;)
        val y = freshName(&quot;y&quot;)

        cps(lhs, FunContinuation(x,
          cps(rhs, FunContinuation(y,
            AppContinuation(k, ContAdd(x, y))))))
      }

      case Fun(param, body) =&gt;
        AppContinuation(k,
          ContFun(param, 'dynk, cps(body, 'dynk)))

        // in the function body, we have two continuations:
        //
        // k: continuation from where the lambda is
        //    (static continuation)
        //
        // dynk: continuation from where the application is
        //       (dynamic continuation)

      case App (funExpr, argExpr) =&gt;
        cps(funExpr, FunContinuation('f,
          cps(argExpr, FunContinuation('a,
            ContApp('f, 'a, k)))))
    }
}

import transform._

// Experiments show that this transformation works, but also that
// it creates unnecessary expressions of the form:
//
//   AppContinuation(FunContinuation(name, body), value)
//
// 1. These expressions are called &quot;administrative redexes&quot;.
//
// 2. We could write the administrative redexes as
//
//      wthContinuation(name, value, body)
//
//    with wthContinuation defined like wth from an earlier lecture.
//
// 3. The AppContinuation part of the administrative redexes are
//    created in the cases for expressions that are already
//    trivial (Num, Id, and Fun).
//
// 4. The FunContinuation part of the administrative redexes are
//    created in the recursive calls of cps.
//
// =&gt; The administrative redexes are created because cps always
//    creates a nontrivial expression in CPS, but sometimes a
//    trivial expression in CPS would be shorter and more
//    appropriate.
</code></pre>
            </td>
        </tr>
        
        </tbody>
    </table>
</div>
</body>
</html>
